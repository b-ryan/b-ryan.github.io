<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>Related models in a RESTful API</title>

            <link href="http://buckryan.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="buckryan.com Full Atom Feed" />
            <link href="http://buckryan.com/feeds/python.atom.xml" type="application/atom+xml" rel="alternate" title="buckryan.com Categories Atom Feed" />
        <!-- Bootstrap Core CSS -->
        <link href="http://buckryan.com/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="http://buckryan.com/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="http://buckryan.com/theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="How to organize related models in a RESTful interface">


        <meta name="tags" content="python">
        <meta name="tags" content="rest">
        <meta name="tags" content="api">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="buckryan.com">

	<meta property="og:type" content="article">
	<meta property="og:url" content="http://buckryan.com/related-models-in-a-restful-api.html">
	<meta property="og:title" content="Related models in a RESTful API">
	<meta property="article:published_time" content="2013-10-19 00:00:00">
            <meta property="og:description" content="How to organize related models in a RESTful interface">

            <meta property="og:image" content="http://buckryan.com/theme/images/post-bg.jpg">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="@_buckryan">
        <meta name="twitter:title" content="Related models in a RESTful API">

            <meta name="twitter:image" content="http://buckryan.com/theme/images/post-bg.jpg">

            <meta name="twitter:description" content="How to organize related models in a RESTful interface">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://buckryan.com/">buckryan.com</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                            <li><a href="http://buckryan.com/pages/about.html">about</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('http://buckryan.com/theme/images/post-bg.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Related models in a RESTful API</h1>
                        <span class="meta">Posted by
                             on Sat 19 October 2013
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>I've been working on a personal finance application for the last few months. At
the moment it is called "Buckit" - a name suggested by my housemate since my
name is Buck and buck is also a nickname for dollar. At some point I think I
will come up with a way to integrate the name into the app. Maybe, since I plan
to add budgeting functionality, the different budgets one sets will be called
Buckits (like buckets). Anyway, the naming issue not at all the point of this
article.</p>
<p>The software is written in Python in the back and coffeescript/angularjs in the
front.  I'm using <a href="http://www.sqlalchemy.org/">sqlalchemy</a> to interact with the
database and as such, have small set of models describing a financial system.
One of those models is the Transaction. Now, a transaction is made up of
different stuff than you may initially think. Particularly, the transaction
itself does not have information about amounts and where they're coming from or
going to. Rather, a transaction contains a date, the person or institution
giving or receiving the funds, and it has two or more "splits." The splits are
what define an amount and the account associated with it. Let's look at an
example.</p>
<p>Suppose you went to your local supermarket and spent $20 on groceries using
your debit card. This is one transaction where $20 came out of one account
("debit card") and went into another ("groceries"). The transaction would look
like this:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;today&quot;</span><span class="p">,</span>
    <span class="nt">&quot;splits&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;account&quot;</span><span class="p">:</span> <span class="s2">&quot;debit card&quot;</span><span class="p">,</span>
            <span class="nt">&quot;amount&quot;</span><span class="p">:</span> <span class="mi">-20</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;account&quot;</span><span class="p">:</span> <span class="s2">&quot;groceries&quot;</span><span class="p">,</span>
            <span class="nt">&quot;amount&quot;</span><span class="p">:</span> <span class="mi">20</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p>To represent this, there are separate sqlalchemy models for transactions and
splits. Here is the trimmed down code for the models:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Transaction</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;transactions&#39;</span>

    <span class="nb">id</span>         <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">date</span>       <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span>

    <span class="n">splits</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Split&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Split</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;transaction_splits&#39;</span>

    <span class="nb">id</span>                 <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">transaction_id</span>     <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;transactions.id&#39;</span><span class="p">))</span>
    <span class="n">account_id</span>         <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;accounts.id&#39;</span><span class="p">))</span>
    <span class="n">amount</span>             <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">)</span>
</pre></div>


<p>Interacting with these models over HTTP is done via a pretty basic REST
interface. Here are some endpoints:</p>
<div class="highlight"><pre><span></span><span class="err">GET /transactions - Fetch all transactions</span>
<span class="err">GET /transactions/3 - Fetch the transaction with id 3</span>
<span class="err">POST /transactions - Save a new transaction</span>
<span class="err">PUT /transactions - Update a transaction</span>
</pre></div>


<p>But what exactly should, for example, the <code>GET /transactions/3</code> endpoint
return? It could be just the transaction:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;yesterday&quot;</span>
<span class="p">}</span>
</pre></div>


<p>Or it could include the splits:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;yesterday&quot;</span><span class="p">,</span>
    <span class="nt">&quot;splits&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span>
            <span class="nt">&quot;account_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;amount&quot;</span><span class="p">:</span> <span class="mi">-5</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
            <span class="nt">&quot;account_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;amount&quot;</span><span class="p">:</span> <span class="mi">5</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p>But since the <code>Split</code> model references the <code>accounts</code> table, should the
account model be included too? Where does it end!?</p>
<p>And what about the <code>POST</code> requests? When saving a transaction with three
splits, should I create the whole transaction and save it in one POST request?
Ie. save this:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;last week&quot;</span><span class="p">,</span>
    <span class="nt">&quot;splits&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;account_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">-10.99</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;account_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">10.99</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p>It's a similar question as above - if I'm able to save splits with the endpoint
for saving transactions, is this also going to be able to save accounts? Where
does it end!? The alternative is that in order to save the transaction and
splits you see above, three POSTs are required. First, save the transaction.
Use the Id of the object returned to then save each split individually. But
this seems bothersome and I was a bit worried about the coffeescript code that
would be needed to make this happen. This is because I knew that after saving
the transaction and its splits to the database, I would want to show the
resultant objects in a list of transactions. However, the angularjs <code>$http</code>
service sends HTTP requests asynchronously. Waiting for the transaction and all
of its splits to save before adding them to the list of transactions <em>could</em>
look something like:</p>
<div class="highlight"><pre><span></span><span class="nv">transaction = </span><span class="k">new</span> <span class="nx">Transaction</span>
    <span class="nv">date: </span><span class="s">&#39;today&#39;</span>

<span class="nx">transaction</span><span class="p">.</span><span class="nx">$save</span> <span class="nf">() -&gt;</span>
    <span class="c1"># this code will run once the POST request finishes</span>
    <span class="nv">transaction.splits = </span><span class="p">[</span>
        <span class="k">new</span> <span class="nx">Split</span>
            <span class="nv">transaction_id: </span><span class="nx">transaction</span><span class="p">.</span><span class="nx">id</span>
            <span class="nv">account_id: </span><span class="mi">1</span>
            <span class="nv">amount: </span><span class="o">-</span><span class="mf">3.50</span>

        <span class="k">new</span> <span class="nx">Split</span>
            <span class="nv">transaction_id: </span><span class="nx">transaction</span><span class="p">.</span><span class="nx">id</span>
            <span class="nv">account_id: </span><span class="mi">2</span>
            <span class="nv">amount: </span><span class="mf">3.50</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="nx">split</span> <span class="k">in</span> <span class="nx">splits</span>
        <span class="nx">split</span><span class="p">.</span><span class="nx">$save</span><span class="p">()</span>
</pre></div>


<p>Luckily, angular's awesome two-way data binding allows me to add the
transaction to the list of transactions without waiting for the splits to save.
But there's another problem we didn't think about - what if one of the splits
fails to save? The whole transaction would be corrupted. Perhaps to fix we'd
then go back through the splits and the transaction and delete them from the
database or mark them in some way to indicate the transaction is not complete.</p>
<p>In the end, it's much simpler and more reliable to save the splits along with
the transaction in one big POST request.</p>
    </article>

        <div class="tags">
            <p>tags: <a href="http://buckryan.com/tag/python.html">python</a>, <a href="http://buckryan.com/tag/rest.html">rest</a>, <a href="http://buckryan.com/tag/api.html">api</a></p>
        </div>

    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://twitter.com/_buckryan">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/b-ryan">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>. <br />        &copy;  Buck Ryan
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="http://buckryan.com/theme/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="http://buckryan.com/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="http://buckryan.com/theme/js/clean-blog.min.js"></script>

<script type="text/javascript">
    var disqus_shortname = 'buckryan';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>