<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>Om, Clojurescript, and Testing</title>

            <link href="http://buckryan.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="buckryan.com Full Atom Feed" />
            <link href="http://buckryan.com/feeds/.atom.xml" type="application/atom+xml" rel="alternate" title="buckryan.com Categories Atom Feed" />
        <!-- Bootstrap Core CSS -->
        <link href="http://buckryan.com/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="http://buckryan.com/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="http://buckryan.com/theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->





        <meta name="tags" content="">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="buckryan.com">

	<meta property="og:type" content="article">
	<meta property="og:url" content="http://buckryan.com/om-clojurescript-and-testing.html">
	<meta property="og:title" content="Om, Clojurescript, and Testing">
	<meta property="article:published_time" content="2015-07-16 00:00:00">

            <meta property="og:image" content="http://buckryan.com/theme/images/post-bg.jpg">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="@_buckryan">
        <meta name="twitter:title" content="Om, Clojurescript, and Testing">

            <meta name="twitter:image" content="http://buckryan.com/theme/images/post-bg.jpg">

            <meta name="twitter:description" content="">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://buckryan.com/">buckryan.com</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                            <li><a href="http://buckryan.com/pages/about.html">about</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('http://buckryan.com/theme/images/post-bg.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Om, Clojurescript, and Testing</h1>
                        <span class="meta">Posted by
                             on Thu 16 July 2015
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>This past week I started learning React, Om, and Clojurescript all at once.
When beginning to use <a href="https://github.com/cemerick/clojurescript.test">cemerick's
.clojurescript.test</a>, I kept
running into this error:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span>Error: cemerick is undefined

ERROR: cemerick.cljs.test was not required.

You can resolve this issue by ensuring [cemerick.cljs.test] appears
in the :require clause of your test suite namespaces.
Also make sure that your build has actually included any test files.
</pre></div>
</td></tr></table>

<p>But I clearly had included it in my test! I googled and grumbled, but could not
figure out what was wrong. Finally I discovered that
<a href="https://slimerjs.org/">slimerjs</a> has the <code>-jsconsole</code> flag, which, as the docs
say, will</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>Open a window to view all javascript errors during the execution
</pre></div>
</td></tr></table>

<p>Great, using that I finally found the actual problem:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span>Script Error: Error: Assert failed: No target specified to om.core/root
(not (nil? target))
       Stack:
         -&gt; file:///tmp/runner6386761518784950059.js.html: 55456
</pre></div>
</td></tr></table>

<p>This makes much more sense. The issue is that my <code>core.cljs</code> namespace was
running <code>om/root</code> when the page loads. The code looked like:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">om/root</span> <span class="nv">main-view</span>
         <span class="nv">app-state</span>
         <span class="p">{</span><span class="ss">:target</span> <span class="p">(</span><span class="k">. </span><span class="nv">js/document</span> <span class="p">(</span><span class="nf">getElementById</span> <span class="s">&quot;app&quot;</span><span class="p">))}))</span>
</pre></div>
</td></tr></table>

<p>But since the tests are not loading the index.html page (as they shouldn't),
there is no element with ID app. Ultimately the problem is with running code
at the namespace level. What would be preferred would be if there were some
way to specify a main function to initialize the app. This would be run for
the actual application, but not the tests.</p>
<h1>First take at a Solution</h1>
<p>It took awhile of searching, but I finally found some inspiration from
<a href="https://github.com/jalehman/react-tutorial-om">this project</a> and specifically
<a href="https://github.com/jalehman/react-tutorial-om/blob/60867fb0efcb48a3f20bc94361c2f981e6c96f44/resources/public/index.html#L15">this line of code</a>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;</span><span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;react_tutorial_om.app&quot;</span><span class="p">);&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table>

<p>I realized I could just wrap my <code>om/root</code> call in a main function and then call
this from the index.html page. Here is what the code in <code>core.cljs</code> looks like
now:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">app</span> <span class="p">[]</span>
  <span class="p">(</span><span class="nf">om/root</span> <span class="nv">main-view</span>
           <span class="nv">app-state</span>
           <span class="p">{</span><span class="ss">:target</span> <span class="p">(</span><span class="k">. </span><span class="nv">js/document</span> <span class="p">(</span><span class="nf">getElementById</span> <span class="s">&quot;app&quot;</span><span class="p">))}))</span>
</pre></div>
</td></tr></table>

<p>and the corresponding code in <code>index.html</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;</span>
<span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;my.namespace.core&quot;</span><span class="p">);</span>
<span class="nx">my</span><span class="p">.</span><span class="nx">namespace</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">app</span><span class="p">();</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table>

<p>Now running the tests no longer had any problem. However, I realized that
lein figwheel was not reloading the page properly when I made changes to the
code. This is because the javascript would be reloaded, which previously was
running <code>om/root</code> every time. To solve this I added to the <code>on-js-reload</code>
function so that the app was reinitialized:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">on-js-reload</span> <span class="p">[]</span>
  <span class="p">(</span><span class="nf">app</span><span class="p">))</span>
</pre></div>
</td></tr></table>

<h1>Improving the Solution</h1>
<p>As I continued learning about Om, I came across the
<a href="https://github.com/omcljs/om-cookbook">om-cookbook</a> repository. The following
is based on the structure of the project in the
<code>recipes/routing-with-secretary</code> directory (and possibly others in the repo).</p>
<p>Let's assume your project currently has this directory structure:</p>
<div class="highlight"><pre><span></span>resources/...
src/my/namespace/core.cljs
project.clj
</pre></div>


<p>We are going to add a directory called <code>env</code> which will house code that is
specific to different environments, namely development vs. production. Create
directories such that your project now looks like this:</p>
<div class="highlight"><pre><span></span>env/dev/src/my/namespace/dev.cljs
   /prod/src/my/namespace/prod.cljs
resources/...
src/my/namespace/core.cljs
project.clj
</pre></div>


<p>You can see that in <code>env/dev</code> and <code>env/prod</code> we mimick the <code>src</code> directory.
Within <code>dev.cljs</code> we will add code that is only to be run when developing.
Here is what that namespace will basically look like for the dev environment:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">ns </span><span class="nv">my.namespace.dev</span>
  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">my.namespace.core</span> <span class="ss">:as</span> <span class="nv">core</span><span class="p">]</span>
            <span class="p">[</span><span class="nv">figwheel.client</span> <span class="ss">:as</span> <span class="nv">figwheel</span> <span class="ss">:include-macros</span> <span class="nv">true</span><span class="p">]))</span>

<span class="p">(</span><span class="nf">enable-console-print!</span><span class="p">)</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">on-js-reload</span> <span class="p">[]</span>
  <span class="p">(</span><span class="nf">core/app</span><span class="p">))</span>

<span class="p">(</span><span class="nf">core/app</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>For production, this can be much simpler:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">ns </span><span class="nv">my.namespace.prod</span>
  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">my.namespace.core</span> <span class="ss">:as</span> <span class="nv">core</span><span class="p">]))</span>

<span class="p">(</span><span class="nf">core/app</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>Now all we need to do is modify <code>project.clj</code> to use these environments. This
is accomplished using different build configurations. Here is a sample of
how that would look:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ss">:cljsbuild</span> <span class="p">{</span><span class="ss">:builds</span> <span class="p">[{</span><span class="ss">:id</span> <span class="s">&quot;dev&quot;</span>
                      <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src&quot;</span> <span class="s">&quot;env/dev/src&quot;</span><span class="p">]</span>
                      <span class="c1">; blah blah blah</span>
                      <span class="p">}</span>
                     <span class="p">{</span><span class="ss">:id</span> <span class="s">&quot;prod&quot;</span>
                      <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src&quot;</span> <span class="s">&quot;env/prod/src&quot;</span><span class="p">]</span>
                      <span class="c1">; blah blah blah</span>
                      <span class="p">}</span>
                     <span class="p">{</span><span class="ss">:id</span> <span class="s">&quot;test&quot;</span>
                      <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src&quot;</span> <span class="s">&quot;test&quot;</span><span class="p">]</span>
                      <span class="c1">; blah blah blah</span>
                      <span class="p">}]}</span>
</pre></div>
</td></tr></table>

<p>Finally, make sure to remove the code that was added to <code>index.html</code> in our
first take at a solution.</p>
<p>And there you have it. The dev environment will end up compiling <code>dev.cljs</code>,
and since this namespace includes a call to <code>core/app</code> at the namespace-level,
it will run when the javascript is loaded. We do not include the file for the
test build, meaning the tests do not try to run <code>om/root</code>.</p>
<h1>Alternative Approach</h1>
<p>An entirely different approach to all of this (and perhaps a lot simpler)
would be to simply check if your target element exists. Your code could then
look like</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">if-let </span><span class="p">[</span><span class="nv">target</span> <span class="p">(</span><span class="k">. </span><span class="nv">js/document</span> <span class="p">(</span><span class="nf">getElementById</span> <span class="s">&quot;app&quot;</span><span class="p">))]</span>
  <span class="p">(</span><span class="nf">om/root</span> <span class="nv">main-view</span>
           <span class="nv">app-state</span>
           <span class="p">{</span><span class="ss">:target</span> <span class="nv">target</span><span class="p">}))</span>
</pre></div>
</td></tr></table>

<p>You might prefer this approach. The reason I tend to not like this is that you
still have functionality that executes when you require the namespace. It also
introduces a silent failure. If you change the main element to have a different
id, your app would just show up blank with no errors printed.</p>
<p>I was pretty surprised to not be able to find anything about this. Maybe I'm
missing something obvious. I am new to Clojurescript and Om, so it could just
be a newbie mistake. If so let me know!</p>
    </article>

        <div class="tags">
            <p>tags: <a href="http://buckryan.com/tag/.html"></a></p>
        </div>

    <hr>

        <div class="comments">
            <h2>Comments !</h2>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'buckryan';
                var disqus_identifier = 'om-clojurescript-and-testing.html';
                var disqus_url = 'http://buckryan.com/om-clojurescript-and-testing.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//buckryan.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://twitter.com/_buckryan">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/b-ryan">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>. <br />        &copy;  Buck Ryan
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="http://buckryan.com/theme/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="http://buckryan.com/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="http://buckryan.com/theme/js/clean-blog.min.js"></script>

<script type="text/javascript">
    var disqus_shortname = 'buckryan';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>